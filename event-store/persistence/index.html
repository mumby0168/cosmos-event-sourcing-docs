<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Persistence | Cosmos Event Sourcing</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="Make use of Cosmos DB as an event store">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/cosmos-event-sourcing-docs/assets/css/0.styles.c3244ff2.css" as="style"><link rel="preload" href="/cosmos-event-sourcing-docs/assets/js/app.c889ef55.js" as="script"><link rel="preload" href="/cosmos-event-sourcing-docs/assets/js/2.e3883e0f.js" as="script"><link rel="preload" href="/cosmos-event-sourcing-docs/assets/js/11.85dbee3e.js" as="script"><link rel="prefetch" href="/cosmos-event-sourcing-docs/assets/js/10.dc2e3a6d.js"><link rel="prefetch" href="/cosmos-event-sourcing-docs/assets/js/12.e32a73b6.js"><link rel="prefetch" href="/cosmos-event-sourcing-docs/assets/js/13.f5b9886e.js"><link rel="prefetch" href="/cosmos-event-sourcing-docs/assets/js/14.d64601fd.js"><link rel="prefetch" href="/cosmos-event-sourcing-docs/assets/js/15.3459d247.js"><link rel="prefetch" href="/cosmos-event-sourcing-docs/assets/js/16.13e5ca33.js"><link rel="prefetch" href="/cosmos-event-sourcing-docs/assets/js/17.4ad77b05.js"><link rel="prefetch" href="/cosmos-event-sourcing-docs/assets/js/18.662d8444.js"><link rel="prefetch" href="/cosmos-event-sourcing-docs/assets/js/19.3fcca83d.js"><link rel="prefetch" href="/cosmos-event-sourcing-docs/assets/js/20.e48b2a4a.js"><link rel="prefetch" href="/cosmos-event-sourcing-docs/assets/js/21.1f1e0cdf.js"><link rel="prefetch" href="/cosmos-event-sourcing-docs/assets/js/22.9013fb91.js"><link rel="prefetch" href="/cosmos-event-sourcing-docs/assets/js/23.27cd1266.js"><link rel="prefetch" href="/cosmos-event-sourcing-docs/assets/js/3.32b655d3.js"><link rel="prefetch" href="/cosmos-event-sourcing-docs/assets/js/4.e27a7f7a.js"><link rel="prefetch" href="/cosmos-event-sourcing-docs/assets/js/5.e9f4081f.js"><link rel="prefetch" href="/cosmos-event-sourcing-docs/assets/js/6.c7b54f12.js"><link rel="prefetch" href="/cosmos-event-sourcing-docs/assets/js/7.81b258a5.js"><link rel="prefetch" href="/cosmos-event-sourcing-docs/assets/js/8.fc67d087.js"><link rel="prefetch" href="/cosmos-event-sourcing-docs/assets/js/9.effed064.js">
    <link rel="stylesheet" href="/cosmos-event-sourcing-docs/assets/css/0.styles.c3244ff2.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/cosmos-event-sourcing-docs/" class="home-link router-link-active"><img src="/cosmos-event-sourcing-docs/small-logo.jpg" alt="Cosmos Event Sourcing" class="logo"> <span class="site-name can-hide">Cosmos Event Sourcing</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/cosmos-event-sourcing-docs/getting-started/" class="nav-link">
  Docs
</a></div><div class="nav-item"><a href="/cosmos-event-sourcing-docs/samples/" class="nav-link">
  Samples
</a></div><div class="nav-item"><a href="https://discord.com/invite/qMXrX4shAv" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Discord
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/IEvangelist/azure-cosmos-dotnet-repository" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/cosmos-event-sourcing-docs/getting-started/" class="nav-link">
  Docs
</a></div><div class="nav-item"><a href="/cosmos-event-sourcing-docs/samples/" class="nav-link">
  Samples
</a></div><div class="nav-item"><a href="https://discord.com/invite/qMXrX4shAv" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Discord
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/IEvangelist/azure-cosmos-dotnet-repository" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/cosmos-event-sourcing-docs/getting-started/" class="sidebar-heading clickable"><span>Getting Started</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/cosmos-event-sourcing-docs/getting-started/" class="sidebar-link">Overview</a></li><li><section class="sidebar-group is-sub-group depth-1"><a href="/cosmos-event-sourcing-docs/getting-started/guide/00-overview/" class="sidebar-heading clickable"><span>Guide</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/cosmos-event-sourcing-docs/getting-started/guide/01-domain-implementation.html" class="sidebar-link">Domain Implementation</a></li><li><a href="/cosmos-event-sourcing-docs/getting-started/guide/02-store-config.html" class="sidebar-link">Configuring a Store</a></li><li><a href="/cosmos-event-sourcing-docs/getting-started/guide/03-replaying-events.html" class="sidebar-link">Replaying Events</a></li><li><a href="/cosmos-event-sourcing-docs/getting-started/guide/04-read-projection.html" class="sidebar-link">Building a Read Projection</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/cosmos-event-sourcing-docs/event-store/" class="sidebar-heading clickable router-link-active open"><span>Event Store</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/cosmos-event-sourcing-docs/event-store/persistence/" aria-current="page" class="active sidebar-link">Persistence</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/cosmos-event-sourcing-docs/event-store/persistence/#events" class="sidebar-link">Events</a></li><li class="sidebar-sub-header"><a href="/cosmos-event-sourcing-docs/event-store/persistence/#aggregate-roots" class="sidebar-link">Aggregate Roots</a></li><li class="sidebar-sub-header"><a href="/cosmos-event-sourcing-docs/event-store/persistence/#acid-transactions" class="sidebar-link">ACID Transactions</a></li><li class="sidebar-sub-header"><a href="/cosmos-event-sourcing-docs/event-store/persistence/#correlation" class="sidebar-link">Correlation</a></li></ul></li><li><a href="/cosmos-event-sourcing-docs/event-store/reading/" class="sidebar-link">Reading</a></li></ul></section></li><li><a href="/cosmos-event-sourcing-docs/projections/" class="sidebar-link">Projections</a></li><li><a href="/cosmos-event-sourcing-docs/learning/" class="sidebar-link">Learning Resources</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="persistence"><a href="#persistence" class="header-anchor">#</a> Persistence</h1> <p>The <code>IEventStore&lt;TEventItem&gt;</code> offers a few different ways to persist events into the store. Each method that you could choose to use does ultimately the same thing, stores a set of <code>EventItem</code>'s into the database. However, each method offers a different way to write these events following some different patterns that are worth explaining.</p> <div class="custom-block tip"><p class="custom-block-title">Tip</p> <p>If you want to use an interface which only support's write operations the library offers the <a href="https://github.com/IEvangelist/azure-cosmos-dotnet-repository/blob/main/src/Microsoft.Azure.CosmosEventSourcing/Stores/IWriteOnlyEventStore.cs" target="_blank" rel="noopener noreferrer"><code>IWriteOnlyEventStore&lt;TEventItem&gt;</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <h2 id="events"><a href="#events" class="header-anchor">#</a> Events</h2> <p>The libraries offers an API which supports saving collections of <code>EventItem</code>'s as transactional batches (see the <a href="#acid-transactions">ACID Transactions</a> section for more information).</p> <p>See a simple example of using the <code>PersistAsync(...)</code> method below, this example reads all the events off of an <code>AggregateRoot</code> and saves them using the <code>IEventStore&lt;TEventItem&gt;</code>.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ShipRepository</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IShipRepository</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IEventStore<span class="token punctuation">&lt;</span>ShipEventItem<span class="token punctuation">&gt;</span></span> _store<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">ShipRepository</span><span class="token punctuation">(</span><span class="token class-name">IEventStore<span class="token punctuation">&lt;</span>ShipEventItem<span class="token punctuation">&gt;</span></span> store<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _store <span class="token operator">=</span> store<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">ValueTask</span> <span class="token function">SaveAsync</span><span class="token punctuation">(</span><span class="token class-name">Ship</span> ship<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">List<span class="token punctuation">&lt;</span>ShipEventItem<span class="token punctuation">&gt;</span></span> events <span class="token operator">=</span> ship
            <span class="token punctuation">.</span>NewEvents
            <span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span>
                <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ShipEventItem</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> ship<span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        events<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">ShipEventItem</span><span class="token punctuation">(</span>ship<span class="token punctuation">.</span>AtomicEvent<span class="token punctuation">,</span> ship<span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> _store<span class="token punctuation">.</span><span class="token function">PersistAsync</span><span class="token punctuation">(</span>events<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="aggregate-roots"><a href="#aggregate-roots" class="header-anchor">#</a> Aggregate Roots</h2> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token comment">//TODO:</span>
</code></pre></div><h2 id="acid-transactions"><a href="#acid-transactions" class="header-anchor">#</a> ACID Transactions</h2> <p>The library supports full ACID transactions on events being persisted. It is a common scenario in event sourcing that you could have multiple consumers in parallel reading what they think is current state of an aggregate. They then apply one or many new events to there current picture of an aggregate. It is <em>important</em> that when both of the consumers write back there new events that only one update wins. If they where to both write there events this can cause issues. One issue is that there would be multiple events with the same <code>Sequence</code> number. You would also have no guarantee that when you replay those events again that they would be valid when being applied to your aggregate.</p> <p>In order to combat this complexity the library makes use of two features of Cosmos DB. The first is the <a href="https://docs.microsoft.com/en-us/azure/cosmos-db/sql/transactional-batch" target="_blank" rel="noopener noreferrer">transaction batch feature.<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> The second is the <a href="https://docs.microsoft.com/en-us/azure/cosmos-db/sql/database-transactions-optimistic-concurrency#optimistic-concurrency-control" target="_blank" rel="noopener noreferrer">optimistic concurrency control<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <p>These two features of Cosmos DB work great together, the transactional batch ensures that either all insert/update operations succeed or fail as a batch. Optimistic concurrency control prevents lost updates and ensures only one concurrent insert/update will ever succeed. In order to implement optimistic concurrency control on a set of events the library always reads back and saves a special event. This is called the <code>AtomicEvent</code> every time you persist new events you must provide this event. This is also required by the libraries <code>AggregateRoot</code> implementation when replaying events. Whenever, you add a new event the time stamp on the <code>AtomicEvent</code> is updated. This will force it's record in the database to be assigned a new <code>etag</code> (used by Cosmos DB to implement optimistic concurrency control), if another consumer tries to write it's <code>AtomicEvent</code> back with a different <code>etag</code> value it will fail. This would fail the transactional batch operation. Resulting in <em>no</em> new events being persisting.</p> <p>If an update fails when persisting a new set of events the library throws a custom exception <a href="https://github.com/IEvangelist/azure-cosmos-dotnet-repository/blob/main/src/Microsoft.Azure.CosmosRepository/Exceptions/BatchOperationException.cs" target="_blank" rel="noopener noreferrer"><code>BatchOperationException</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. This contains the native <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.azure.cosmos.transactionalbatchresponse?view=azure-dotnet" target="_blank" rel="noopener noreferrer"><code>TransactionalBatchResponse</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> provided by the Azure Cosmos DB .NET SDK. A consumer can use this to inspect why the update operation failed.</p> <p>As a consumer of this library there are a few ways to handle this exception gracefully:</p> <ol><li>If it was the result of a user request it may be reasonable to simply ask them to try again.</li> <li>If the operation that is performing the update is coming from a message broker, then a lot of these implement the concept of abandoning a message. This can be used to re-process this operation again a few seconds later.</li> <li>Use a <a href="https://github.com/App-vNext/Polly" target="_blank" rel="noopener noreferrer">Polly<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> policy implementation to retry the full operation again.</li></ol> <div class="custom-block warning"><p class="custom-block-title">Caution</p> <p>It is <em>important</em> in any of the above solutions that the full operation is retried. i.e. read the new state of the aggregate and re-apply the new events on the <em>new</em> version of the aggregate.</p></div> <h2 id="correlation"><a href="#correlation" class="header-anchor">#</a> Correlation</h2> <p>The event sourcing provider supports correlation IDs. These can be setup by consuming the scoped service <code>IContextService</code> and setting the <code>IContextService.CorrelationId</code> property. This will then be written into Cosmos DB for each event that was created in that context. This is also automatically populated when consuming changes from the change feed (projections).</p> <p>See below for some example middleware that makes use of the popular <code>CorrelationId</code> package for ASPNET CORE, to set a correlation ID for every HTTP request.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>app<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span>context<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
<span class="token punctuation">{</span>
    <span class="token class-name">ICorrelationContextAccessor</span> correlationContextAccessor <span class="token operator">=</span>
        context<span class="token punctuation">.</span>RequestServices<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetRequiredService</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>ICorrelationContextAccessor<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token class-name">IContextService</span> contextService <span class="token operator">=</span> context<span class="token punctuation">.</span>RequestServices
        <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetRequiredService</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IContextService<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    contextService<span class="token punctuation">.</span>CorrelationId <span class="token operator">=</span> correlationContextAccessor<span class="token punctuation">.</span>CorrelationContext<span class="token punctuation">.</span>CorrelationId<span class="token punctuation">;</span>

    <span class="token keyword">await</span> next<span class="token punctuation">.</span><span class="token function">Invoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/IEvangelist/azure-cosmos-dotnet-repository/edit/master/event-store/persistence/README.md" target="_blank" rel="noopener noreferrer">Contribute to this page</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">1/3/2023, 3:01:14 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/cosmos-event-sourcing-docs/getting-started/guide/04-read-projection.html" class="prev">
        Building a Read Projection
      </a></span> <span class="next"><a href="/cosmos-event-sourcing-docs/event-store/reading/">
        Reading
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/cosmos-event-sourcing-docs/assets/js/app.c889ef55.js" defer></script><script src="/cosmos-event-sourcing-docs/assets/js/2.e3883e0f.js" defer></script><script src="/cosmos-event-sourcing-docs/assets/js/11.85dbee3e.js" defer></script>
  </body>
</html>
