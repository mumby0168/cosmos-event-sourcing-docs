(window.webpackJsonp=window.webpackJsonp||[]).push([[21],{420:function(t,s,e){"use strict";e.r(s);var a=e(56),n=Object(a.a)({},(function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("h1",{attrs:{id:"projections"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#projections"}},[t._v("#")]),t._v(" Projections")]),t._v(" "),e("p",[t._v("Projections allow you to build up an alternate view of your events, notify system's outside your domains boundary of this event and more! This is done by processing all new events in a separate process much like you would process events off of a queue.")]),t._v(" "),e("p",[t._v("This is fully supported in the library by making using of a feature of Cosmos DB called the change feed. The change feed is a persistent log of writes and updates to any items in a container. This means whenever we write a new event, this will be picked up by the change feed. We can then setup a background worker to process these changes.")]),t._v(" "),e("p",[t._v("Projections can be used as a read store to show current state of an "),e("code",[t._v("AggregateRoot")]),t._v(" "),e("em",[t._v("without")]),t._v(" having to replay all the events. For "),e("code",[t._v("AggregateRoot")]),t._v("'s that have a lot of events this can often be a good fit. You could also take the opportunity to take this internal event to your application and offer that to other systems by taking this event and placing it on a message broker for example.")]),t._v(" "),e("h2",{attrs:{id:"basic-projections"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#basic-projections"}},[t._v("#")]),t._v(" Basic Projections")]),t._v(" "),e("p",[t._v("The most basic form of a projection is to build another model from the events you are writing to the "),e("code",[t._v("EventStore<TEventItem>")]),t._v(". This model may be a quick snapshot of the current state of your events, or it could be an aggregation of those events into a more meaningful data structure to meet a business requirement. A great example of this is detailed "),e("RouterLink",{attrs:{to:"/getting-started/guide/04-read-projection.html"}},[t._v("here.")]),t._v(" It can also perform another action in your system later in time. This is great for scenarios where an operation needs to occur but it's not critical it happens as part of the same request that say assigns a customer's address. This example show's how that can be done.")],1),t._v(" "),e("div",{staticClass:"custom-block tip"},[e("p",{staticClass:"custom-block-title"},[t._v("Tip")]),t._v(" "),e("p",[t._v("If you haven't already followed the "),e("RouterLink",{attrs:{to:"/getting-started/guide/00-overview.html"}},[t._v("Getting Started - Guide")]),t._v(", it may be best to give that a read, as this example follow's on from it.")],1)]),t._v(" "),e("p",[t._v("Taking the example of the "),e("code",[t._v("CustomerAccount")]),t._v(" let's say that you wanted to send a welcome letter once a customer has provided there address details. This can be done by processing that addition of the "),e("code",[t._v("CustomerAccountAddressAssigned")]),t._v(" event. Let's see an example implementation of an "),e("code",[t._v("IEventItemProjection<TEventItem, TProjectionKey>")]),t._v(" below.")]),t._v(" "),e("div",{staticClass:"language-csharp extra-class"},[e("pre",{pre:!0,attrs:{class:"language-csharp"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("using")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("EventSourcingCustomerAccount"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Events")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("using")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("EventSourcingCustomerAccount"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Items")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("using")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("EventSourcingCustomerAccount"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Models")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("using")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("EventSourcingCustomerAccount"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Services")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("using")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("Microsoft"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Azure"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("CosmosEventSourcing"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Projections")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("using")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("Microsoft"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Azure"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("CosmosRepository")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("namespace")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("EventSourcingCustomerAccount"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Projections")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("record")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("WelcomeLetterProjectionKey")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token type-list"}},[e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("IProjectionKey")])]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("WelcomeLetterProjection")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token type-list"}},[e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("IEventItemProjection"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("CustomerAccountEventItem"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" WelcomeLetterProjectionKey"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])])]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("readonly")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("IReadOnlyRepository"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("CustomerAccountReadItem"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" _repository"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("readonly")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("IPostalService")]),t._v(" _postalService"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("WelcomeLetterProjection")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("IReadOnlyRepository"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("CustomerAccountReadItem"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" repository"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("IPostalService")]),t._v(" postalService"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        _repository "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" repository"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        _postalService "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" postalService"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token return-type class-name"}},[t._v("ValueTask")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("ProjectAsync")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("CustomerAccountEventItem")]),t._v(" eventItem"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("CancellationToken")]),t._v(" cancellationToken "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("default")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("eventItem"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("DomainEvent "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("is")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("CustomerAccountAddressAssigned")]),t._v(" addressAssigned"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("CustomerAccountReadItem"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("?")])]),t._v(" account "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" _repository"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("TryGetAsync")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n                addressAssigned"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Username"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                "),e("span",{pre:!0,attrs:{class:"token named-parameter punctuation"}},[t._v("cancellationToken")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" cancellationToken"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n            "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("account "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("is")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("not")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" _postalService"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("SendWelcomeLetterAsync")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n                    account"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("FirstName"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                    account"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Surname"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token constructor-invocation class-name"}},[t._v("CustomerAddress")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n                        addressAssigned"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("AddressLine1"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                        addressAssigned"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("AddressLine2"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                        addressAssigned"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("City"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                        addressAssigned"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Country"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                        addressAssigned"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("PostCode"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),e("p",[t._v("This example simply processes an events that are of the type "),e("code",[t._v("CustomerAccountAddressAssigned")]),t._v(" and uses an "),e("code",[t._v("IPostalService")]),t._v(" to send a welcome letter. This happens in it's own process triggered via a background service when the event is written.")]),t._v(" "),e("p",[t._v("Take not of the "),e("code",[t._v("WelcomeLetterProjectionKey")]),t._v(" record at the top of the file.")]),t._v(" "),e("div",{staticClass:"language-csharp extra-class"},[e("pre",{pre:!0,attrs:{class:"language-csharp"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("record")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("WelcomeLetterProjectionKey")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token type-list"}},[e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("IProjectionKey")])]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),e("p",[t._v("This is used by the library to provide a separate processor running against the change feed for each projection you want to build. Think of this much like multiple subscribers from a topic, a single event is written to the topic and it can span out to many consumers. The same works with change feed processors. These are then added to the library with a name that describes the projection that is being built or the action that is being performed. See below:")]),t._v(" "),e("div",{staticClass:"language-csharp extra-class"},[e("pre",{pre:!0,attrs:{class:"language-csharp"}},[e("code",[t._v("builder"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Services"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("AddCosmosEventSourcing")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("eventSourcingBuilder "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    eventSourcingBuilder"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("AddCosmosRepository")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("options "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        options"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("DatabaseId "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"customer-accounts-sample-db"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        options"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ContainerBuilder\n            "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token generic-method"}},[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("ConfigureEventItemStore")]),e("span",{pre:!0,attrs:{class:"token generic class-name"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("CustomerAccountEventItem"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])])]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n                "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"customer-account-events"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token generic-method"}},[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("ConfigureProjectionStore")]),e("span",{pre:!0,attrs:{class:"token generic class-name"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("CustomerAccountReadItem"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])])]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n                "),e("span",{pre:!0,attrs:{class:"token named-parameter punctuation"}},[t._v("containerName")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"projections"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                "),e("span",{pre:!0,attrs:{class:"token named-parameter punctuation"}},[t._v("partitionKey")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/username"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Other config excluded for brevity")]),t._v("\n\n    eventSourcingBuilder\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token generic-method"}},[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("AddEventItemProjection")]),e("span",{pre:!0,attrs:{class:"token generic class-name"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("CustomerAccountEventItem"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            WelcomeLetterProjectionKey"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            WelcomeLetterProjection"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])])]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n            options "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                options"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ProcessorName "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"welcome-letter-builder"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n                options"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("InstanceName "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Environment"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("MachineName"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Provided by the IEvangelist.CosmosRepository.AspNetCore nuget package.")]),t._v("\nbuilder"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Services"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("AddCosmosRepositoryChangeFeedHostedService")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),e("div",{staticClass:"custom-block tip"},[e("p",{staticClass:"custom-block-title"},[t._v("Tip")]),t._v(" "),e("p",[t._v("The "),e("code",[t._v("WelcomeLetterProjectionKey")]),t._v(" is used in the registration process and is tied directly to the processor with the name "),e("code",[t._v("welcome-letter-builder")]),t._v(". This enables the library to resolve the correct services and start a fresh processor per projection.")])]),t._v(" "),e("p",[t._v("There are two keys point to take not of here. The fist is the processor name, this is used by the Cosmos DB change feed processor library to identify this processor. Let's say we had an application that was scaled horizontally to 3 instances. They all declare a processor with the same name "),e("code",[t._v("welcome-letter-builder")]),t._v(". The library will then distributed all changes across those 3 instances, effectively load balancing changes for you. The second property is the instance name, this should reflect the node or compute instance that the app is running on. In this example we use the machine name, but this could be a pod id in Kubernetes, or a node name on an app service.")]),t._v(" "),e("h2",{attrs:{id:"handling-failures"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#handling-failures"}},[t._v("#")]),t._v(" Handling Failures")]),t._v(" "),e("p",[t._v("It is vitally important that exceptions thrown when processing an event from the change feed is handled properly by the consumer. Depending on the criticality of the role your projection is playing determines how you need to handle the failure of processing an event. The change feed processor library will retry changes infinitely that result in un-handled exceptions. This makes it even more important that non-transient errors handled and logged for manual intervention in the future.")]),t._v(" "),e("p",[t._v("The library also is extremely careful when handling errors in it's part of the changes pipeline. The main place the library has to be careful is when deserializing it's events. The library will return a special event type in the case of a deserialization failure. The "),e("code",[t._v("NonDeserializableEvent")]),t._v(" can be handled by a consumer projections and can provide relevant information, such as the payload as a JObject, the exception that caused the failure, or whether or not the types where just not registered.")])])}),[],!1,null,null,null);s.default=n.exports}}]);