(window.webpackJsonp=window.webpackJsonp||[]).push([[11],{408:function(t,e,s){"use strict";s.r(e);var a=s(56),n=Object(a.a)({},(function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"persistence"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#persistence"}},[t._v("#")]),t._v(" Persistence")]),t._v(" "),s("p",[t._v("The "),s("code",[t._v("IEventStore<TEventItem>")]),t._v(" offers a few different ways to persist events into the store. Each method that you could choose to use does ultimately the same thing, stores a set of "),s("code",[t._v("EventItem")]),t._v("'s into the database. However, each method offers a different way to write these events following some different patterns that are worth explaining.")]),t._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[t._v("Tip")]),t._v(" "),s("p",[t._v("If you want to use an interface which only support's write operations the library offers the "),s("a",{attrs:{href:"https://github.com/IEvangelist/azure-cosmos-dotnet-repository/blob/main/src/Microsoft.Azure.CosmosEventSourcing/Stores/IWriteOnlyEventStore.cs",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("IWriteOnlyEventStore<TEventItem>")]),s("OutboundLink")],1)])]),t._v(" "),s("h2",{attrs:{id:"events"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#events"}},[t._v("#")]),t._v(" Events")]),t._v(" "),s("p",[t._v("The libraries offers an API which supports saving collections of "),s("code",[t._v("EventItem")]),t._v("'s as transactional batches (see the "),s("a",{attrs:{href:"#acid-transactions"}},[t._v("ACID Transactions")]),t._v(" section for more information).")]),t._v(" "),s("p",[t._v("See a simple example of using the "),s("code",[t._v("PersistAsync(...)")]),t._v(" method below, this example reads all the events off of an "),s("code",[t._v("AggregateRoot")]),t._v(" and saves them using the "),s("code",[t._v("IEventStore<TEventItem>")]),t._v(".")]),t._v(" "),s("div",{staticClass:"language-csharp extra-class"},[s("pre",{pre:!0,attrs:{class:"language-csharp"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ShipRepository")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token type-list"}},[s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("IShipRepository")])]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("readonly")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("IEventStore"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("ShipEventItem"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" _store"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("ShipRepository")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("IEventStore"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("ShipEventItem"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" store"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        _store "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" store"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token return-type class-name"}},[t._v("ValueTask")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("SaveAsync")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Ship")]),t._v(" ship"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("List"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("ShipEventItem"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" events "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ship\n            "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("NewEvents\n            "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Select")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("x "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constructor-invocation class-name"}},[t._v("ShipEventItem")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("x"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ship"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Name"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("ToList")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n        events"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Add")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constructor-invocation class-name"}},[t._v("ShipEventItem")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ship"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("AtomicEvent"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ship"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Name"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" _store"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("PersistAsync")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("events"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("h2",{attrs:{id:"aggregate-roots"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#aggregate-roots"}},[t._v("#")]),t._v(" Aggregate Roots")]),t._v(" "),s("div",{staticClass:"language-csharp extra-class"},[s("pre",{pre:!0,attrs:{class:"language-csharp"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//TODO:")]),t._v("\n")])])]),s("h2",{attrs:{id:"acid-transactions"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#acid-transactions"}},[t._v("#")]),t._v(" ACID Transactions")]),t._v(" "),s("p",[t._v("The library supports full ACID transactions on events being persisted. It is a common scenario in event sourcing that you could have multiple consumers in parallel reading what they think is current state of an aggregate. They then apply one or many new events to there current picture of an aggregate. It is "),s("em",[t._v("important")]),t._v(" that when both of the consumers write back there new events that only one update wins. If they where to both write there events this can cause issues. One issue is that there would be multiple events with the same "),s("code",[t._v("Sequence")]),t._v(" number. You would also have no guarantee that when you replay those events again that they would be valid when being applied to your aggregate.")]),t._v(" "),s("p",[t._v("In order to combat this complexity the library makes use of two features of Cosmos DB. The first is the "),s("a",{attrs:{href:"https://docs.microsoft.com/en-us/azure/cosmos-db/sql/transactional-batch",target:"_blank",rel:"noopener noreferrer"}},[t._v("transaction batch feature."),s("OutboundLink")],1),t._v(" The second is the "),s("a",{attrs:{href:"https://docs.microsoft.com/en-us/azure/cosmos-db/sql/database-transactions-optimistic-concurrency#optimistic-concurrency-control",target:"_blank",rel:"noopener noreferrer"}},[t._v("optimistic concurrency control"),s("OutboundLink")],1),t._v(".")]),t._v(" "),s("p",[t._v("These two features of Cosmos DB work great together, the transactional batch ensures that either all insert/update operations succeed or fail as a batch. Optimistic concurrency control prevents lost updates and ensures only one concurrent insert/update will ever succeed. In order to implement optimistic concurrency control on a set of events the library always reads back and saves a special event. This is called the "),s("code",[t._v("AtomicEvent")]),t._v(" every time you persist new events you must provide this event. This is also required by the libraries "),s("code",[t._v("AggregateRoot")]),t._v(" implementation when replaying events. Whenever, you add a new event the time stamp on the "),s("code",[t._v("AtomicEvent")]),t._v(" is updated. This will force it's record in the database to be assigned a new "),s("code",[t._v("etag")]),t._v(" (used by Cosmos DB to implement optimistic concurrency control), if another consumer tries to write it's "),s("code",[t._v("AtomicEvent")]),t._v(" back with a different "),s("code",[t._v("etag")]),t._v(" value it will fail. This would fail the transactional batch operation. Resulting in "),s("em",[t._v("no")]),t._v(" new events being persisting.")]),t._v(" "),s("p",[t._v("If an update fails when persisting a new set of events the library throws a custom exception "),s("a",{attrs:{href:"https://github.com/IEvangelist/azure-cosmos-dotnet-repository/blob/main/src/Microsoft.Azure.CosmosRepository/Exceptions/BatchOperationException.cs",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("BatchOperationException")]),s("OutboundLink")],1),t._v(". This contains the native "),s("a",{attrs:{href:"https://docs.microsoft.com/en-us/dotnet/api/microsoft.azure.cosmos.transactionalbatchresponse?view=azure-dotnet",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("TransactionalBatchResponse")]),s("OutboundLink")],1),t._v(" provided by the Azure Cosmos DB .NET SDK. A consumer can use this to inspect why the update operation failed.")]),t._v(" "),s("p",[t._v("As a consumer of this library there are a few ways to handle this exception gracefully:")]),t._v(" "),s("ol",[s("li",[t._v("If it was the result of a user request it may be reasonable to simply ask them to try again.")]),t._v(" "),s("li",[t._v("If the operation that is performing the update is coming from a message broker, then a lot of these implement the concept of abandoning a message. This can be used to re-process this operation again a few seconds later.")]),t._v(" "),s("li",[t._v("Use a "),s("a",{attrs:{href:"https://github.com/App-vNext/Polly",target:"_blank",rel:"noopener noreferrer"}},[t._v("Polly"),s("OutboundLink")],1),t._v(" policy implementation to retry the full operation again.")])]),t._v(" "),s("div",{staticClass:"custom-block warning"},[s("p",{staticClass:"custom-block-title"},[t._v("Caution")]),t._v(" "),s("p",[t._v("It is "),s("em",[t._v("important")]),t._v(" in any of the above solutions that the full operation is retried. i.e. read the new state of the aggregate and re-apply the new events on the "),s("em",[t._v("new")]),t._v(" version of the aggregate.")])]),t._v(" "),s("h2",{attrs:{id:"correlation"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#correlation"}},[t._v("#")]),t._v(" Correlation")]),t._v(" "),s("p",[t._v("The event sourcing provider supports correlation IDs. These can be setup by consuming the scoped service "),s("code",[t._v("IContextService")]),t._v(" and setting the "),s("code",[t._v("IContextService.CorrelationId")]),t._v(" property. This will then be written into Cosmos DB for each event that was created in that context. This is also automatically populated when consuming changes from the change feed (projections).")]),t._v(" "),s("p",[t._v("See below for some example middleware that makes use of the popular "),s("code",[t._v("CorrelationId")]),t._v(" package for ASPNET CORE, to set a correlation ID for every HTTP request.")]),t._v(" "),s("div",{staticClass:"language-csharp extra-class"},[s("pre",{pre:!0,attrs:{class:"language-csharp"}},[s("code",[t._v("app"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Use")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("context"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" next"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ICorrelationContextAccessor")]),t._v(" correlationContextAccessor "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("\n        context"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("RequestServices"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token generic-method"}},[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("GetRequiredService")]),s("span",{pre:!0,attrs:{class:"token generic class-name"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("ICorrelationContextAccessor"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    \n    "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("IContextService")]),t._v(" contextService "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" context"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("RequestServices\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token generic-method"}},[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("GetRequiredService")]),s("span",{pre:!0,attrs:{class:"token generic class-name"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("IContextService"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    contextService"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("CorrelationId "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" correlationContextAccessor"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("CorrelationContext"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("CorrelationId"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" next"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Invoke")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])])])}),[],!1,null,null,null);e.default=n.exports}}]);